# CVE-2021-44228 Log4Shell
## What's All About
Apache Log4j2 <=2.14.1 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled.

* **https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/**
* https://logging.apache.org/log4j/2.x/security.html
* https://nvd.nist.gov/vuln/detail/CVE-2021-44228
* https://www.bsi.bund.de/DE/Service-Navi/Presse/Pressemitteilungen/Presse2021/211211_log4Shell_WarnstufeRot.html

## Keep in Mind
* It's not just a server-side vulnerability, it also affects client applications
* HTTP headers are only one way to get attacker supplied strings to Log4j2. Usernames, file content, etc. can also be used
* It's not just LDAP, but also RMI and DNS. If outbound TCP is blocked, for instance, DNS can be used to exfiltrate data
  * https://twitter.com/captainGeech42/status/1470055184449613829

# Mitigation, Detection, Response
## General Approach
1. Get an overview of affected systems and software
2. Use general blocking / access limiting approaches (IPS, WAF, etc.)
3. Patch internet facing software and devices
4. Patch internal software and devices (*they are also very important!*)
5. Search for exploitation attempts and follow up on them

## Overview / Identification
In order to identify potentially affected systems and software, multiple tools and searches can be used.

### Well-known Applications and Products
* https://github.com/NCSC-NL/log4shell/tree/main/software
* https://gist.github.com/SwitHak/b66db3a06c2955a9cb71a8718970c592

### Tools for Detection
**Local Scanners**
* https://github.com/Neo23x0/Fenrir/releases/tag/v0.9.0
* https://github.com/mergebase/log4j-detector
* https://github.com/dtact/divd-2021-00038--log4j-scanner
* https://github.com/hillu/local-log4j-vuln-scanner
* https://github.com/logpresso/CVE-2021-44228-Scanner

**Remote Scanners**
* For Burp: https://github.com/whwlsfb/Log4j2Scan
* HTTP based: https://github.com/fullhunt/log4j-scan
* Tenable Nessus: https://www.tenable.com/log4j
  * Relevant Plugins: https://community.tenable.com/s/article/Plugins-associated-with-CVE-2021-44228-Log4Shell
    * Generally look for Plugins
      * `log4j`
      * `CVE-2021-44228`
  * Note the following:
    * Credentialed Scan (probably better detection rate): https://docs.tenable.com/nessus/Content/CredentialedChecksOnWindows.htm
    * For Uncredentialed Scan: https://community.tenable.com/s/feed/0D53a00008EPbXGCA1
    * Perform Thorough Tests: https://community.tenable.com/s/article/How-the-Thorough-checks-setting-affects-your-scan

## Blocking Known IOCs
Known IOCs should be blocked wherever possible.

### Permimeter
* Check if your WAF, Firewall, IPS, etc. has a signature update that blocks CVE-2021-44228 exploitation attempts

| Product | Link |
|---------|------|
| OWASP ModSecurity | https://coreruleset.org/20211213/crs-and-log4j-log4shell-cve-2021-44228/ |
| Checkpoint | https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS |
| AWS WAF / Shield | https://aws.amazon.com/security/security-bulletins/AWS-2021-005/ |
| Cloudflare WAF | https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation/ |
| Palo Alto | https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/ |
| Snort / Surricata | https://rules.emergingthreatspro.com/open/ |
| Microsoft | <ul><li>https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/</li><li>https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/</li></ul> |

* Block outgoing traffic as far as possible for LDAP, RMI and DNS (TCP and UDP)
* Block known bad IPs and Tor nodes
  * Tor Nodes: 
    * https://check.torproject.org/torbulkexitlist
  * Known-Bad IPs: 
    * https://gist.github.com/gnremy/c546c7911d5f876f263309d7161a7217
    * https://urlhaus.abuse.ch/browse/tag/log4j/
    * https://threatfox.abuse.ch/browse/tag/log4j/

## Patching / Mitigation
* **Patch it: Log4j >=2.16.0**
* Log4j >= 2.10
  * Set `log4j2.formatMsgNoLookups` (`LOG4J_FORMAT_MSG_NO_LOOKUPS` as environment variable) to `true`
    * Source: https://logging.apache.org/log4j/2.x/security.html

`Attention: This might not be enough! https://issues.apache.org/jira/browse/LOG4J2-3221`

* Log4j 2.0-beta9 to <2.10.0
  * Remove `JndiLookup` from the classpath: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`
    * Source: https://logging.apache.org/log4j/2.x/security.html
* Remove the `JndiLookup` and `JndiManager` classes from the `log4j-core` jar
  * Source: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
* Spring Framework: `spring.jndi.ignore=true`
  * https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/

`However, do you really catch all affected applications? These Mitigations are likely not enough.`

### NO LONGER RECOMMENDED (BAD!)
**!! DO NOT USE THE FOLLOWING MITIGATIONS !!**
* `%m{nolookups}` in the PatternLayout configuration to prevent lookups in log event messages.
  * Source: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
  * Why it is a *bad* idea: https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide/#updating-individual-log-statements-isnt-a-complete-fix

## Search for Exploitation Attempts
Once identified and also patched the systems and libraries, one might want to identify whether the vulnerability has been successfully abused. 

### General
* Idea collection by Florian Roth: https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b

### Tools
* https://github.com/Neo23x0/log4shell-detector
* https://github.com/Neo23x0/Fenrir/releases/tag/v0.9.0
* https://www.nextron-systems.com/2021/12/12/log4shell-detection-with-thor/

### SIEMs
* Elastic: https://www.elastic.co/blog/detecting-log4j2-with-elastic-security
  * Check if JVM process connects to a known LDAP, RMI or DNS port (likely high FP rate)
  * Check JVM for suspicious child processes (likely high FP rate)
* Splunk: https://www.splunk.com/en_us/blog/security/log-jammin-log4j-2-rce.html


# Additional Infos
## IOCs
* https://urlhaus.abuse.ch/browse/tag/log4j/
* https://threatfox.abuse.ch/browse/tag/log4j/
* https://github.com/curated-intel/Log4Shell-IOCs
* https://gist.github.com/nathanqthai/01808c569903f41a52e7e7b575caa890
* https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
* https://gist.github.com/gnremy/c546c7911d5f876f263309d7161a7217
* https://github.com/NCSC-NL/log4shell/tree/main/iocs
* https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv
  * Source: https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/

## Attack Examples
* https://twitter.com/zom3y3/status/1469508032887414784
* https://twitter.com/OguzhanTopgul/status/1469586742294450179
* https://blog.cloudflare.com/actual-cve-2021-44228-payloads-captured-in-the-wild/

## Tweets
* https://twitter.com/search?q=(CVE-2021-44228%20OR%20log4j%20OR%20log4j2)&f=live

## Exploitation Attempts Since...
* 2021-12-01 04:36:50 UTC (Cloudflare)
  * Source: https://twitter.com/eastdakota/status/1469800951351427073
* 2021-12-02 (Cisco Talos)
  * Source: https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html

## Further Resources
* https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
* https://isc.sans.edu/diary/28120
* https://www.lunasec.io/docs/blog/log4j-zero-day/
* https://blog.cloudflare.com/how-cloudflare-security-responded-to-log4j2-vulnerability/
* https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/
* https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot
* https://github.com/YfryTchsGD/Log4jAttackSurface
* https://www.wired.com/story/log4j-flaw-hacking-internet/
* https://github.com/advisories/GHSA-jfh8-c2jp-5v3q
* https://www.cert.govt.nz/it-specialists/advisories/log4j-rce-0-day-actively-exploited/
* https://blog.checkpoint.com/2021/12/11/protecting-against-cve-2021-442228-apache-log4j2-versions-2-14-1/
* https://www.tenable.com/blog/cve-2021-44228-proof-of-concept-for-critical-apache-log4j-remote-code-execution-vulnerability
* https://twitter.com/entropyqueen_/status/1469606438632833027

# CVE Details
* https://logging.apache.org/log4j/2.x/security.html
* https://nvd.nist.gov/vuln/detail/CVE-2021-44228

## Keep in Mind
* It's not just a server-side vulnerability, it also affects client applications
* HTTP headers are only one way to get attacker supplied strings to Log4j2. Usernames, file content, etc. can also be used
* It's not just LDAP, but also RMI and DNS. If outbound TCP is blocked, for instance, DNS can be used to exfiltrate data
  * https://twitter.com/captainGeech42/status/1470055184449613829

## Exploitation Attempts Since...
* 2021-12-01 04:36:50 UTC (Cloudflare)
  * Source: https://twitter.com/eastdakota/status/1469800951351427073
* 2021-12-02 (Cisco Talos)
  * Source: https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html

## Must Reads
* https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/
  * Especially the first image on how to prevent attacks
* https://isc.sans.edu/diary/28122
* https://www.bsi.bund.de/DE/Service-Navi/Presse/Pressemitteilungen/Presse2021/211211_log4Shell_WarnstufeRot.html
* https://twitter.com/cyb3rops/status/1469596693066829836
* https://twitter.com/bettersafetynet/status/1469470284977745932

# Affected Applications
## Find Applications
### Local
* Hashes of affected Log4j versions: https://github.com/mubix/CVE-2021-44228-Log4Shell-Hashes
* https://github.com/mergebase/log4j-detector
* https://github.com/dtact/divd-2021-00038--log4j-scanner
* https://github.com/hillu/local-log4j-vuln-scanner
* https://github.com/logpresso/CVE-2021-44228-Scanner
* https://github.com/Neo23x0/Fenrir/releases/tag/v0.9.0
* Using YARA-Rules, should also find Log4j in binaries: https://github.com/darkarnium/CVE-2021-44228

### Over the Network
* For Burp: https://github.com/whwlsfb/Log4j2Scan
* HTTP based: https://github.com/fullhunt/log4j-scan

### Helper (Token Generation for Testing)
* https://twitter.com/ThinkstCanary/status/1469439743905697797
* https://log4shell.huntress.com/
  * https://www.huntress.com/blog/rapid-response-critical-rce-vulnerability-is-affecting-java#vulnerability-tool

### See also:
  * https://www.nextron-systems.com/2021/12/12/log4shell-detection-with-thor/

## Well-known Applications and Products
* https://github.com/NCSC-NL/log4shell/tree/main/software
* https://gist.github.com/SwitHak/b66db3a06c2955a9cb71a8718970c592

# Mitigation, Detection, Response
## General Approach
* Check if your WAF, Firewall, IPS, etc. has a signature update that blocks CVE-2021-44228 exploitation attempts
* Check if your EDR product is capable to detect the vulnerability and/or detect its exploitation (=> update the signatures/EDR)
* Block outgoing traffic as far as possible for LDAP, RMI and DNS (TCP and UDP)
* Block known bad IPs and Tor nodes
* Search for Log4j (= affected applications) on your servers and clients
  * Use a security vulnerability scanner or your SIEM/logging infrastructure
  * Use the known hashes of affected Log4j files
  * Search for Log4j config files or even the "log4j" string on your filesystems
  * Search for exploitation attempts (also hints at potentially affected applications)
* Mitigate the vulnerability itself (based on the previous search)
  * Best option: Patch it
  * Not so great option: Remove the affected component and/or apply the mitigating property

### Priority
1. Get an overview of affected systems and software
2. Use general blocking / access limiting approaches (IPS, WAF, etc.)
3. Patch internet facing software and devices
4. Patch internal software and devices (*they are also very important!*)
5. Search for exploitation attempts and follow up on them

## Generale Notes
### Mitigation
* Patch it: Log4j >=2.15.0
* Log4j >= 2.10
  * Set `log4j2.formatMsgNoLookups` (`LOG4J_FORMAT_MSG_NO_LOOKUPS` as environment variable) to `true`
    * Source: https://logging.apache.org/log4j/2.x/security.html
    * *Attention*: This might be now enough! https://issues.apache.org/jira/browse/LOG4J2-3221
* Log4j 2.0-beta9 to <2.10.0
  * Remove `JndiLookup` from the classpath: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`
    * Source: https://logging.apache.org/log4j/2.x/security.html
* Log4j >= 2.7
  * > "%m{nolookups} in the PatternLayout configuration to prevent lookups in log event messages"
    * Source: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
* > Remove the `JndiLookup` and `JndiManager` classes from the `log4j-core` jar
  * Source: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
* Spring Framework: `spring.jndi.ignore=true`
  * https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/
* However, do you really catch all affected applications? These Mitigations are likely not enough.

### Filter/Detection
* Stop traffic to LDAP, RMI and DNS as far as possible from potentially affected application or networks
* Cybereason: https://github.com/Cybereason/Logout4Shell
  * Idea: Use the vulnerability to force the Java application to set the mitigation property `FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS`
  * Source: https://www.cybereason.com/blog/cybereason-releases-vaccine-to-prevent-exploitation-of-apache-log4shell-vulnerability-cve-2021-44228
* Regex: ``\${(\${(.*?:|.*?:.*?:-)('|"|`)*(?1)}*|[jndi:lapsrm]('|"|`)*}*){9,11}``
  * Source (2021-12-12): https://github.com/NCSC-NL/log4shell/tree/main/mitigation
* Filtering for specific strings can likely be bypassed:
  * https://github.com/Puliczek/CVE-2021-44228-PoC-log4j-bypass-words
  * https://twitter.com/cyb3rops/status/1469596693066829836
  * https://twitter.com/Rezn0k/status/1469523006015750146
  * https://twitter.com/_MG_/status/1469517383794520065
  * https://twitter.com/h4x0r_dz/status/1469663187079417857

### See Also
* https://github.com/NCSC-NL/log4shell/tree/main/mitigation#closed-source-intelligence

## Block IPs
* Tor Exit Nodes will very likely be used
  * https://check.torproject.org/torbulkexitlist
    * https://blog.torproject.org/changes-tor-exit-list-service/
* Source IPs trying to exploit the vulnerability
  * https://gist.github.com/gnremy/c546c7911d5f876f263309d7161a7217
    * Source: https://twitter.com/GreyNoiseIO/status/1469334738225741832
  * https://urlhaus.abuse.ch/browse/tag/log4j/
  * https://threatfox.abuse.ch/browse/tag/log4j/

## Security Products
* OWASP ModSecurity Core Rule Set: https://coreruleset.org/20211213/crs-and-log4j-log4shell-cve-2021-44228/
* Check Point: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
* AWS WAF / Shield: https://aws.amazon.com/security/security-bulletins/AWS-2021-005/
  * Screenshot: https://twitter.com/ImEavesDroppin/status/1469414393469280257
* Cloudflare WAF: https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation/
* Palo Alto: https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/
  * Threat Prevention (Firewall module): Threat ID 91991
  * Cortex XDR
  * Prisma Cloud Compute can check for vulnerable systems
* Snort / Suricata:
  * https://rules.emergingthreatspro.com/open/
    * 2034647
    * 2034648
    * 2034648
    * 2034649
    * 2034650
    * 2034651
    * 2034652
  * According to https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
    * 58722 - 58739
    * 300055 - 300057
* ClamAV:
  * Java.Exploit.CVE_2021_44228-9914600-1
  * Java.Exploit.CVE_2021_44228-9914601-1
  * Source: https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
* Cisco: https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
  * Cisco Secure Firewall "can detect malicious activity associated with this threat"
* Microsoft: https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/
  * Detection & Hunting: https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/

## Exploitation Detection
* https://github.com/Neo23x0/log4shell-detector
* https://github.com/Neo23x0/Fenrir/releases/tag/v0.9.0
* Idea collection by Florian Roth: https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b
* Elastic: https://www.elastic.co/blog/detecting-log4j2-with-elastic-security
  * Check if JVM process connects to a known LDAP, RMI or DNS port (likely high FP rate)
  * Check JVM for suspicious child processes (likely high FP rate)
* Splunk: https://www.splunk.com/en_us/blog/security/log-jammin-log4j-2-rce.html

## IOCs
* https://urlhaus.abuse.ch/browse/tag/log4j/
* https://threatfox.abuse.ch/browse/tag/log4j/
* https://github.com/curated-intel/Log4Shell-IOCs
* https://gist.github.com/nathanqthai/01808c569903f41a52e7e7b575caa890
* https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
* https://gist.github.com/gnremy/c546c7911d5f876f263309d7161a7217
* https://github.com/NCSC-NL/log4shell/tree/main/iocs

# Attack Examples
* https://twitter.com/zom3y3/status/1469508032887414784
* https://twitter.com/OguzhanTopgul/status/1469586742294450179
* https://blog.cloudflare.com/actual-cve-2021-44228-payloads-captured-in-the-wild/

# Tweets
https://twitter.com/search?q=(CVE-2021-44228%20OR%20log4j%20OR%20log4j2)&f=live

# Further Resources
* https://isc.sans.edu/diary/28120
* https://www.lunasec.io/docs/blog/log4j-zero-day/
* https://blog.cloudflare.com/how-cloudflare-security-responded-to-log4j2-vulnerability/
* https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/
* https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot
* https://github.com/YfryTchsGD/Log4jAttackSurface
* https://www.wired.com/story/log4j-flaw-hacking-internet/
* https://github.com/advisories/GHSA-jfh8-c2jp-5v3q
* https://www.cert.govt.nz/it-specialists/advisories/log4j-rce-0-day-actively-exploited/
* https://blog.checkpoint.com/2021/12/11/protecting-against-cve-2021-442228-apache-log4j2-versions-2-14-1/
* https://www.tenable.com/blog/cve-2021-44228-proof-of-concept-for-critical-apache-log4j-remote-code-execution-vulnerability
* https://twitter.com/entropyqueen_/status/1469606438632833027

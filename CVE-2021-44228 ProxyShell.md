# CVE Details
* https://logging.apache.org/log4j/2.x/security.html
* https://nvd.nist.gov/vuln/detail/CVE-2021-44228

## Must Reads
* https://twitter.com/cyb3rops/status/1469596693066829836
* https://twitter.com/bettersafetynet/status/1469470284977745932

# Find affected applications
* https://twitter.com/ThinkstCanary/status/1469439743905697797
* https://log4shell.huntress.com/
  * https://www.huntress.com/blog/rapid-response-critical-rce-vulnerability-is-affecting-java#vulnerability-tool
* https://github.com/whwlsfb/Log4j2Scan
* Hashes of affected Log4j versions: https://github.com/mubix/CVE-2021-44228-Log4Shell-Hashes

# Mitigation
* Patch it: Log4j >=2.15.0
* Stop traffic to LDAP, RMI and DNS as far as possible from potentially affected application or networks
* Cybereason: https://github.com/Cybereason/Logout4Shell
  * Idea: Use the vulnerability to force the Java application to set the mitigation property `FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS`
  * Source: https://www.cybereason.com/blog/cybereason-releases-vaccine-to-prevent-exploitation-of-apache-log4shell-vulnerability-cve-2021-44228
* Log4j >= 2.10
  * Set `log4j2.formatMsgNoLookups` (`LOG4J_FORMAT_MSG_NO_LOOKUPS` as environment variable) to `true`
    * Source: https://logging.apache.org/log4j/2.x/security.html
* Log4j 2.0-beta9 to <2.10.0
  * Remove `JndiLookup` from the classpath: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`
    * Source: https://logging.apache.org/log4j/2.x/security.html
* Log4j >= 2.7
  * > "%m{nolookups} in the PatternLayout configuration to prevent lookups in log event messages"
    * Source: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
* > Remove the `JndiLookup` and `JndiManager` classes from the `log4j-core` jar
  * Source: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
* Spring Framework: `spring.jndi.ignore=true`
  * https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/
* However, do you really catch all affected applications? Mitigations are likely not enough.
* Filtering for specific strings can likely be bypassed:
  * https://twitter.com/cyb3rops/status/1469596693066829836
  * https://twitter.com/Rezn0k/status/1469523006015750146
  * https://twitter.com/_MG_/status/1469517383794520065


# Protect
## Block IPs
* Tor Exit Notes will very likely be used
  * https://check.torproject.org/torbulkexitlist
    * https://blog.torproject.org/changes-tor-exit-list-service/
* Source IPs trying to exploit the vulnerability
  * https://gist.github.com/gnremy/c546c7911d5f876f263309d7161a7217
    * Source: https://twitter.com/GreyNoiseIO/status/1469334738225741832

## Security Products
* Check Point: https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk176865&partition=Basic&product=IPS
* AWS WAF / Shield: https://aws.amazon.com/security/security-bulletins/AWS-2021-005/
  * Screenshot: https://twitter.com/ImEavesDroppin/status/1469414393469280257
* Cloudflare WAF: https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation/
* Palo Alto: https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/
  * Threat Prevention (Firewall module): Threat ID 91991
  * Cortex XDR
  * Prisma Cloud Compute can check for vulnerable systems
* Snort / Suricata:
  * https://rules.emergingthreatspro.com/open/
    * 2034647
    * 2034648
    * 2034648
    * 2034649
    * 2034650
    * 2034651
    * 2034652
  * According to https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
    * 58722 - 58739
    * 300055 - 300057
* ClamAV:
  * Java.Exploit.CVE_2021_44228-9914600-1
  * Java.Exploit.CVE_2021_44228-9914601-1
  * Source: https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
* Cisco: https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
  * Cisco Secure Firewall "can detect malicious activity associated with this threat"

# Detect & Respond
* Idea collection by Florian Roth: https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b
* Elastic: https://www.elastic.co/blog/detecting-log4j2-with-elastic-security
  * Check if JVM process connects to a known LDAP, RMI or DNS port (likely high FP rate)
  * Check JVM for suspicious child processes (likely high FP rate)
* Splunk: https://www.splunk.com/en_us/blog/security/log-jammin-log4j-2-rce.html
* Be careful:
  * The string might be in *any* input of an application. Not only in a HTTP header.

## IOCs
* https://blog.talosintelligence.com/2021/12/apache-log4j-rce-vulnerability.html
* https://gist.github.com/gnremy/c546c7911d5f876f263309d7161a7217

# Attack Examples
* https://twitter.com/zom3y3/status/1469508032887414784
* https://twitter.com/OguzhanTopgul/status/1469586742294450179

# Further Resources
* https://www.lunasec.io/docs/blog/log4j-zero-day/
* https://blog.cloudflare.com/how-cloudflare-security-responded-to-log4j2-vulnerability/
* https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/
* https://isc.sans.edu/diary/28120
* https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot
* https://github.com/YfryTchsGD/Log4jAttackSurface
* https://www.wired.com/story/log4j-flaw-hacking-internet/
* https://github.com/advisories/GHSA-jfh8-c2jp-5v3q